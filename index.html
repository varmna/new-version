<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conversation Annotator</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--primary-color: #007bff;
--success-color: #28a745;
--warning-color: #ffc107;
--error-color: #dc3545;
--text-primary: #333;
--text-secondary: #666;
--border-color: #ddd;
--background-light: #f8f9fa;
--sidebar-width: 400px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
background: #fff;
color: var(--text-primary);
line-height: 1.6;
height: 100vh;
overflow: hidden;
}
.upload-screen {
display: flex;
justify-content: center;
align-items: center;
min-height: 100vh;
padding: 20px;
background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
.upload-container {
background: white;
padding: 40px;
border-radius: 12px;
box-shadow: 0 8px 30px rgba(0,0,0,0.1);
max-width: 600px;
width: 100%;
text-align: center;
}
.upload-box {
position: relative;
border: 2px dashed #ccc;
border-radius: 8px;
padding: 40px;
margin-top: 20px;
text-align: center;
transition: all 0.3s ease;
cursor: pointer;
}
.upload-box:hover {
border-color: var(--primary-color);
background: #f8f9fa;
}
.upload-icon {
width: 64px;
height: 64px;
margin: 0 auto 20px;
fill: #007bff;
}
.main-interface {
display: flex;
flex-direction: column;
height: 100vh;
overflow: hidden;
}
.top-bar {
background: #fff;
border-bottom: 1px solid var(--border-color);
padding: 12px 20px;
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 10px;
}
.top-bar h1 {
font-size: 18px;
font-weight: 600;
color: var(--text-primary);
}
.top-bar-actions {
display: flex;
gap: 15px;
align-items: center;
flex-wrap: wrap;
}
.progress-info {
display: flex;
align-items: center;
gap: 15px;
}
.progress-text {
font-size: 14px;
color: var(--text-secondary);
}
.annotated-count {
font-size: 13px;
padding: 4px 10px;
background: #e7f3ff;
color: #0066cc;
border-radius: 4px;
font-weight: 500;
white-space: nowrap;
}
.content-wrapper {
display: flex;
flex: 1;
overflow: hidden;
}
.main-content {
flex: 1;
display: flex;
flex-direction: column;
overflow: hidden;
background: var(--background-light);
}
.conversation-header {
background: #fff;
padding: 15px 20px;
border-bottom: 1px solid var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
flex-wrap: wrap;
gap: 10px;
}
.conversation-metadata {
display: flex;
gap: 20px;
align-items: center;
font-size: 14px;
}
.status-indicator {
display: flex;
align-items: center;
gap: 8px;
padding: 6px 12px;
border-radius: 4px;
font-size: 13px;
font-weight: 500;
}
.status-annotated {
background: #d4edda;
color: #155724;
}
.status-not-annotated {
background: #fff3cd;
color: #856404;
}
.conversation-display {
flex: 1;
overflow-y: auto;
padding: 20px;
background: #f5f5f5;
}
.message {
padding: 15px;
margin: 10px 0;
border-radius: 8px;
max-width: 80%;
box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.message-header {
font-size: 12px;
color: var(--text-secondary);
margin-bottom: 8px;
font-weight: 500;
}
.customer {
background: #e8f4fd;
margin-left: auto;
border-left: 3px solid #007bff;
}
.bot {
background: #fff;
margin-right: auto;
border-left: 3px solid #ffc107;
}
.navigation-bar {
background: #fff;
padding: 15px 20px;
border-top: 1px solid var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
gap: 15px;
flex-wrap: wrap;
}
.nav-buttons {
display: flex;
gap: 10px;
}
.jump-to-section {
display: flex;
align-items: center;
gap: 10px;
background: var(--background-light);
padding: 8px 12px;
border-radius: 6px;
border: 1px solid var(--border-color);
}
.jump-to-section label {
font-size: 13px;
color: var(--text-secondary);
white-space: nowrap;
font-weight: 500;
}
.jump-to-section input {
width: 70px;
padding: 6px 10px;
border: 1px solid var(--border-color);
border-radius: 4px;
font-size: 14px;
text-align: center;
font-weight: 500;
}
.progress-bar-wrapper {
flex: 1;
max-width: 600px;
min-width: 200px;
overflow-x: auto;
}
.progress-bar {
width: 100%;
height: 32px;
background: #e9ecef;
border-radius: 8px;
display: flex;
cursor: pointer;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
border: 2px solid #dee2e6;
}
.progress-segment {
height: 100%;
transition: all 0.2s ease;
border-right: 2px solid rgba(255,255,255,0.6);
position: relative;
flex-shrink: 0;
min-width: 3px;
}
.progress-segment:last-child {
border-right: none;
}
.progress-segment:hover {
opacity: 0.85;
transform: scaleY(1.15);
}
.progress-segment.annotated {
background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}
.progress-segment.not-annotated {
background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
}
.progress-segment.current {
box-shadow: 0 0 0 3px #007bff;
z-index: 20;
transform: scaleY(1.2);
}
.sidebar {
width: var(--sidebar-width);
background: #fff;
border-left: 1px solid var(--border-color);
display: flex;
flex-direction: column;
overflow: hidden;
}
.sidebar-header {
padding: 15px 20px;
border-bottom: 1px solid var(--border-color);
}
.sidebar-header h2 {
font-size: 16px;
font-weight: 600;
}
.sidebar-content {
flex: 1;
overflow-y: auto;
padding: 20px;
}
.form-section {
margin-bottom: 20px;
}
.form-section-title {
font-size: 14px;
font-weight: 600;
color: var(--text-primary);
margin-bottom: 10px;
}
.required-star {
color: var(--error-color);
}
.checkbox-list {
display: flex;
flex-direction: column;
gap: 4px;
}
.checkbox-item {
display: flex;
align-items: center;
gap: 8px;
padding: 6px 0;
}
.checkbox-item input[type="checkbox"] {
width: 16px;
height: 16px;
cursor: pointer;
}
.checkbox-item label {
cursor: pointer;
font-size: 13px;
}
.bucket-details {
margin-left: 24px;
margin-top: 8px;
margin-bottom: 12px;
padding: 10px;
background: var(--background-light);
border-radius: 4px;
border-left: 3px solid var(--primary-color);
}
.form-control-compact {
margin-bottom: 8px;
}
.radio-group {
display: flex;
flex-direction: column;
gap: 8px;
}
.radio-option {
display: flex;
align-items: center;
gap: 8px;
padding: 8px 0;
}
.radio-option input[type="radio"] {
width: 16px;
height: 16px;
cursor: pointer;
}
.radio-option label {
cursor: pointer;
font-size: 14px;
}
.form-control {
width: 100%;
padding: 8px 12px;
border: 1px solid var(--border-color);
border-radius: 4px;
font-family: inherit;
font-size: 14px;
}
.form-control:focus {
outline: none;
border-color: var(--primary-color);
}
textarea.form-control {
resize: vertical;
min-height: 80px;
}
.sidebar-footer {
padding: 15px 20px;
border-top: 1px solid var(--border-color);
}
.unsaved-indicator {
display: none;
font-size: 12px;
color: var(--warning-color);
margin-bottom: 10px;
}
.unsaved-indicator.show {
display: block;
}
.btn {
padding: 8px 16px;
border: none;
border-radius: 4px;
font-size: 14px;
font-weight: 500;
cursor: pointer;
transition: all 0.2s ease;
display: inline-flex;
align-items: center;
gap: 6px;
}
.btn-primary {
background: var(--primary-color);
color: white;
}
.btn-primary:hover {
background: #0056b3;
}
.btn-success {
background: var(--success-color);
color: white;
width: 100%;
}
.btn-success:hover {
background: #218838;
}
.btn-outline {
background: white;
color: var(--text-primary);
border: 1px solid var(--border-color);
}
.btn-outline:hover {
background: var(--background-light);
}
.btn-sm {
padding: 7px 14px;
font-size: 13px;
}
.badge {
display: inline-block;
padding: 4px 10px;
border-radius: 4px;
font-size: 12px;
font-weight: 600;
}
.badge-success {
background: #d4edda;
color: #155724;
}
.badge-danger {
background: #f8d7da;
color: #721c24;
}
.status-message {
position: fixed;
bottom: 20px;
right: 20px;
padding: 12px 24px;
border-radius: 4px;
background: white;
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
display: none;
z-index: 1000;
font-size: 14px;
}
.status-success { border-left: 4px solid var(--success-color); }
.status-error { border-left: 4px solid var(--error-color); }
.status-warning { border-left: 4px solid var(--warning-color); }
.status-info { border-left: 4px solid var(--primary-color); }
.loading-spinner {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(255,255,255,0.9);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
flex-direction: column;
gap: 20px;
}
.spinner {
width: 40px;
height: 40px;
border: 4px solid #f3f3f3;
border-top: 4px solid var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}
.user-display {
display: flex;
align-items: center;
gap: 8px;
padding: 8px 12px;
background: #e3f2fd;
border-radius: 4px;
font-size: 14px;
font-weight: 500;
color: var(--primary-color);
}
#edit-username-btn {
padding: 4px 8px;
font-size: 12px;
background: transparent;
border: 1px solid var(--primary-color);
color: var(--primary-color);
}
.login-modal {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0,0,0,0.5);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
}
.login-modal-content {
background: white;
padding: 30px;
border-radius: 8px;
box-shadow: 0 4px 20px rgba(0,0,0,0.2);
max-width: 400px;
width: 90%;
text-align: center;
}
.login-modal-content h2 {
margin-bottom: 20px;
}
.login-modal-content input {
width: 100%;
padding: 10px;
border: 1px solid var(--border-color);
border-radius: 4px;
margin-bottom: 20px;
font-size: 16px;
}
.login-modal-content button {
width: 100%;
padding: 10px;
background: var(--primary-color);
color: white;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 16px;
}
.keyboard-shortcuts-hint {
font-size: 11px;
color: var(--text-secondary);
text-align: center;
margin-top: 8px;
}
</style>
</head>
<body>

<div id="login-modal" class="login-modal" style="display: none;">
<div class="login-modal-content">
<h2>Enter Your Login</h2>
<input type="text" id="login-name" placeholder="Your Login" required>
<button id="login-submit">Submit</button>
</div>
</div>

<div id="upload-screen" class="upload-screen">
<div class="upload-container">
<h1>Conversation Annotator</h1>
<div class="upload-box" id="upload-box">
<input type="file" id="excel-upload" accept=".xlsx,.xls" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer;">
<div class="upload-content">
<svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
</svg>
<p>Drag & drop your Excel file here or click to browse</p>
<small>Only .xlsx files are supported</small>
</div>
</div>
</div>
</div>

<div id="main-interface" class="main-interface" style="display: none;">
<div class="top-bar">
<h1>Conversation Annotator</h1>
<div class="top-bar-actions">
<div class="user-display">
 üë§<span id="user-name-display">Not logged in</span>
<button id="edit-username-btn" class="btn btn-sm btn-outline"> </button>
</div>
<div class="progress-info">
<span class="progress-text" id="progress-text">0/0</span>
<span class="annotated-count" id="annotated-count">0 Annotated</span>
</div>
<button id="exit-btn" class="btn btn-outline"> Exit</button>
<button id="download-unannotated-btn" class="btn btn-outline"> Download Unannotated</button>
<button id="download-btn" class="btn btn-primary"> Download Annotated</button>
</div>
</div>

<div class="content-wrapper">
<div class="main-content">
<div class="conversation-header">
<div class="conversation-metadata" id="conversation-info"></div>
<div id="annotation-status"></div>
</div>
<div class="conversation-display" id="conversation-display"></div>
<div class="navigation-bar">
<div class="nav-buttons">
<button id="prev-btn" class="btn btn-outline"> Prev</button>
<button id="next-btn" class="btn btn-outline">Next </button>
</div>
<div class="progress-bar-wrapper">
<div class="progress-bar" id="progress-bar"></div>
</div>
<div class="jump-to-section">
<label>Jump:</label>
<input type="number" id="jump-input" min="1" placeholder="#">
<button id="jump-btn" class="btn btn-outline btn-sm">Go</button>
</div>
</div>
</div>

<div class="sidebar">
<div class="sidebar-header">
<h2>Feedback</h2>
</div>
<div class="sidebar-content" id="feedback-form"></div>
<div class="sidebar-footer">
<div class="unsaved-indicator" id="unsaved-indicator"> Unsaved changes</div>
<button id="save-btn" class="btn btn-success">Submit</button>
<div class="keyboard-shortcuts-hint">‚Üê ‚Üí to navigate | Ctrl+S to save</div>
</div>
</div>
</div>
</div>

<div id="status-message" class="status-message"></div>
<div id="loading-spinner" class="loading-spinner">
<div class="spinner"></div>
<p>Processing...</p>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
const tool = {
currentIndex: 0,
conversations: [],
annotations: {},
hasUnsavedChanges: false,
fileName: '',
userName: '',
// I've restored HVA sub intent in buckets so the UI and UX match your original layout
buckets: ["Bot Response","HVA","AB feature/HVA Related Query","HVA sub intent","Personalized/Account-Specific Queries","Bot Limitations","Promo & Freebie Related Queries","Help-page/Direct Customer Service","BP for Non-Profit Organisation Related Query","Personal Prime Related Query","Customer Behavior","Other Queries","Overall Observations"],
hvaOptions: ["N/A","3WM (3-Way Match)","Account Authority","Add User","ATEP (Amazon Tax Exemption Program)","Business Lists","Business Prime","Business Order Information","Custom Quotes","Guided Buying","PBI","Quantity Discount","Shared Settings","SSO","Subscibe & Save","Savings Agent"],
staticComments: {
"AB feature/HVA Related Query": ["HVA Related Query"],
"HVA sub intent": ["SSO","Subscribe & Save","Account Authority","Business Order Information (BOI)","Custom Quotes","3-Way Match","Business Lists","ATEP (Tax Exemption)","PBI (Pay by Invoice)","Guided Buying","Business Prime","General Amazon Business"],
"Personalized/Account-Specific Queries": ["Account Status","Account Specific","Order Related Issue","Pre-order Query","Personalised query","Order Tracking Issue"],
"Bot Limitations": ["Yes","No","N/A"],
"Promo & Freebie Related Queries": [],
"Personal Prime Related Query": ["Amazon Prime Details"],
"BP for Non-Profit Organisation Related Query": ["Non profit organisation query"],
"Help-page/Direct Customer Service": ["Customer's Direct Ask","Bot recommendations"],
"Customer Behavior": ["Negative feedback despite correct bot response"],
"Other Queries": ["Customer annoyed by bot's pop-up","Customer query not understandable","Unrelated to Amazon","Outside Bot's knowledge base but within Amazon Business","Other query","Others - Savings agent"],
"Overall Observations": []
}
};

// map of detailed sub-intents for each HVA primary (used when primary includes SSO/Subscribe etc.)
const subOptionsMap = {
"SSO": [
"SSO: What is it/Benefits overview",
"SSO: Setup and configuration",
"SSO: Login/authentication issues",
"SSO: Add/manage users",
"SSO: Integration problems (IdP, Account Authority)",
"SSO: Disable or remove SSO",
"SSO: Other issues"
],
"Subscibe & Save": [ // note: your HVA option had a spelling "Subscibe & Save" ‚Äî we keep mapping tolerant to both
"Subscribe & Save: What is it/Benefits overview",
"Subscribe & Save: Set up subscription",
"Subscribe & Save: Modify subscription (frequency/quantity)",
"Subscribe & Save: Cancel or skip delivery",
"Subscribe & Save: Discounts and pricing",
"Subscribe & Save: Payment issues (PBI integration)",
"Subscribe & Save: Other issues"
],
"Subscribe & Save": [
"Subscribe & Save: What is it/Benefits overview",
"Subscribe & Save: Set up subscription",
"Subscribe & Save: Modify subscription (frequency/quantity)",
"Subscribe & Save: Cancel or skip delivery",
"Subscribe & Save: Discounts and pricing",
"Subscribe & Save: Payment issues (PBI integration)",
"Subscribe & Save: Other issues"
],
"Account Authority": [
"Account Authority: What is it/Benefits overview",
"Account Authority: Setup and domain verification",
"Account Authority: Consolidate/manage accounts",
"Account Authority: User permissions",
"Account Authority: Spending visibility",
"Account Authority: Disable or remove",
"Account Authority: Other issues"
],
"Business Order Information": [
"BOI: What is it/Benefits overview",
"BOI: Configure fields and dropdowns",
"BOI: Cost center/project codes setup",
"BOI: Make fields required/optional",
"BOI: Reporting and data export",
"BOI: Integration issues",
"BOI: Other issues"
],
"Business Order Information (BOI)": [
"BOI: What is it/Benefits overview",
"BOI: Configure fields and dropdowns",
"BOI: Cost center/project codes setup",
"BOI: Make fields required/optional",
"BOI: Reporting and data export",
"BOI: Integration issues",
"BOI: Other issues"
],
"Custom Quotes": [
"Custom Quotes: What is it/Benefits overview",
"Custom Quotes: Check eligibility ($10k/999 units)",
"Custom Quotes: Request a quote",
"Custom Quotes: Track/manage quotes",
"Custom Quotes: Accept or negotiate pricing",
"Custom Quotes: Seller issues",
"Custom Quotes: Other issues"
],
"3WM (3-Way Match)": [
"3-Way Match: What is it/Benefits overview",
"3-Way Match: Setup and configuration",
"3-Way Match: Confirm deliveries",
"3-Way Match: Invoice reconciliation issues",
"3-Way Match: Mobile app usage",
"3-Way Match: Reports and audit trail",
"3-Way Match: Other issues"
],
"Business Lists": [
"Business Lists: What is it/Benefits overview",
"Business Lists: Create and manage lists",
"Business Lists: Share lists with team",
"Business Lists: Add/remove items",
"Business Lists: Bulk ordering from lists",
"Business Lists: Integration with policies",
"Business Lists: Other issues"
],
"ATEP (Tax Exemption)": [
"ATEP: What is it/Benefits overview",
"ATEP: Check eligibility (nonprofit/gov/edu/reseller)",
"ATEP: Upload/manage certificates",
"ATEP: Tax not exempted (troubleshooting)",
"ATEP: Certificate renewal/expiration",
"ATEP: Multi-state setup",
"ATEP: Other issues"
],
"PBI (Pay by Invoice)": [
"PBI: What is it/Benefits overview",
"PBI: Check eligibility/credit approval",
"PBI: Payment terms and credit limits",
"PBI: Make a payment",
"PBI: Overdue/billing issues",
"PBI: Integration with other features",
"PBI: Other issues"
],
"PBI": [
"PBI: What is it/Benefits overview",
"PBI: Check eligibility/credit approval",
"PBI: Payment terms and credit limits",
"PBI: Make a payment",
"PBI: Overdue/billing issues",
"PBI: Integration with other features",
"PBI: Other issues"
],
"Guided Buying": [
"Guided Buying: What is it/Benefits overview",
"Guided Buying: Check eligibility (Prime requirement)",
"Guided Buying: Create/modify policies",
"Guided Buying: Approval workflows",
"Guided Buying: Policy not working (troubleshooting)",
"Guided Buying: Spending limits and restrictions",
"Guided Buying: Other issues"
],
"Business Prime": [
"Business Prime: What is it/Benefits overview",
"Business Prime: Choose/compare plans",
"Business Prime: Sign up or upgrade",
"Business Prime: Cancel or downgrade",
"Business Prime: Spend visibility/analytics",
"Business Prime: Extended features (PBI terms, Guided Buying)",
"Business Prime: Billing and renewal",
"Business Prime: Other issues"
],
"General Amazon Business": [
"General Amazon Business: What is it/Benefits overview",
"General Amazon Business: Account registration/setup",
"General Amazon Business: Check eligibility for business account",
"General Amazon Business: User management and permissions",
"General Amazon Business: Billing and invoicing",
"General Amazon Business: Analytics and reporting",
"General Amazon Business: Integration (ERP/procurement systems)",
"General Amazon Business: Feature not working (general troubleshooting)",
"General Amazon Business: Other account issues"
]
};

const elements = {
uploadScreen: document.getElementById('upload-screen'),
mainInterface: document.getElementById('main-interface'),
uploadBox: document.getElementById('upload-box'),
fileInput: document.getElementById('excel-upload'),
conversationDisplay: document.getElementById('conversation-display'),
conversationInfo: document.getElementById('conversation-info'),
annotationStatus: document.getElementById('annotation-status'),
feedbackForm: document.getElementById('feedback-form'),
prevBtn: document.getElementById('prev-btn'),
nextBtn: document.getElementById('next-btn'),
saveBtn: document.getElementById('save-btn'),
downloadBtn: document.getElementById('download-btn'),
downloadUnannotatedBtn: document.getElementById('download-unannotated-btn'),
exitBtn: document.getElementById('exit-btn'),
jumpInput: document.getElementById('jump-input'),
jumpBtn: document.getElementById('jump-btn'),
progressText: document.getElementById('progress-text'),
progressBar: document.getElementById('progress-bar'),
annotatedCount: document.getElementById('annotated-count'),
unsavedIndicator: document.getElementById('unsaved-indicator'),
statusMessage: document.getElementById('status-message'),
loadingSpinner: document.getElementById('loading-spinner')
};

const savedUsername = localStorage.getItem('annotator_username');
if (savedUsername) {
tool.userName = savedUsername;
document.getElementById('user-name-display').textContent = savedUsername;
}

function showLoginModal() {
document.getElementById('login-modal').style.display = 'flex';
document.getElementById('login-name').value = tool.userName || '';
document.getElementById('login-name').focus();
}

function handleLogin() {
const name = document.getElementById('login-name').value.trim();
if (name) {
tool.userName = name;
document.getElementById('login-modal').style.display = 'none';
document.getElementById('user-name-display').textContent = name;
localStorage.setItem('annotator_username', name);
return true;
}
showStatus(' Please enter your name', 'warning');
return false;
}

document.getElementById('login-submit').addEventListener('click', handleLogin);
document.getElementById('login-name').addEventListener('keypress', (e) => {
if (e.key === 'Enter') handleLogin();
});
document.getElementById('edit-username-btn').addEventListener('click', showLoginModal);

function showStatus(message, type) {
elements.statusMessage.textContent = message;
elements.statusMessage.className = `status-message status-${type}`;
elements.statusMessage.style.display = 'block';
setTimeout(() => { elements.statusMessage.style.display = 'none'; }, 3000);
}

function showLoading(show) {
elements.loadingSpinner.style.display = show ? 'flex' : 'none';
}

window.markUnsaved = function() {
tool.hasUnsavedChanges = true;
elements.unsavedIndicator.classList.add('show');
};

function clearUnsaved() {
tool.hasUnsavedChanges = false;
elements.unsavedIndicator.classList.remove('show');
}

window.toggleBucketDetails = function(bucket) {
const checkbox = document.querySelector(`input[value="${bucket}"]`);
const details = document.getElementById(`details-${bucket}`);
if (checkbox && details) {
details.style.display = checkbox.checked ? 'block' : 'none';
if (!checkbox.checked) {
details.querySelectorAll('select').forEach(s => s.value = '');
details.querySelectorAll('textarea').forEach(t => t.value = '');
}
markUnsaved();
}
};

// NEW: when primary HVA sub-intent (first select) changes, populate the detail select
window.toggleHVADetail = function(primarySelect) {
const detailSelect = document.getElementById('hva-detail-select');
if (!detailSelect) return;
const primaryValue = primarySelect.value || '';
// find matching key in subOptionsMap (case-insensitive match or partial)
let key = null;
Object.keys(subOptionsMap).forEach(k => {
if (!key) {
if (k.toLowerCase() === primaryValue.toLowerCase() || primaryValue.toLowerCase().includes(k.toLowerCase()) || k.toLowerCase().includes(primaryValue.toLowerCase())) key = k;
}
});
detailSelect.innerHTML = '<option value="">Choose detail...</option>';
if (key && subOptionsMap[key] && subOptionsMap[key].length) {
subOptionsMap[key].forEach(opt => {
const o = document.createElement('option'); o.value = opt; o.textContent = opt; detailSelect.appendChild(o);
});
detailSelect.style.display = 'block';
} else {
detailSelect.style.display = 'none';
detailSelect.value = '';
}
markUnsaved();
};

function createFeedbackForm() {
let html = `
<div class="form-section">
<div class="form-section-title">Bot Response <span class="required-star">*</span></div>
<div class="radio-group">
<div class="radio-option">
<input type="radio" id="accurate" name="bot-response" value="Accurate Response" onchange="markUnsaved()">
<label for="accurate">Accurate response</label>
</div>
<div class="radio-option">
<input type="radio" id="inaccurate" name="bot-response" value="Inaccurate Response" onchange="markUnsaved()">
<label for="inaccurate">Inaccurate response</label>
</div>
</div>
</div>
<div class="form-section">
<div class="form-section-title">Select HVA <span class="required-star">*</span></div>
<select class="form-control" id="hva-select" onchange="markUnsaved()">
<option value="">Select an HVA</option>
${tool.hvaOptions.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
</select>
</div>
<div class="form-section">
<div class="form-section-title">Annotation Categories <span class="required-star">*</span></div>
<div class="checkbox-list">`;

// Build buckets (keeps same UI layout as your old code). For HVA sub intent we add primary + detail selects.
tool.buckets.slice(2, -1).forEach((bucket, idx) => {
html += `
<div class="checkbox-item">
<input type="checkbox" id="bucket-${idx}" name="bucket-checkbox" value="${bucket}" onchange="toggleBucketDetails('${bucket}')">
<label for="bucket-${idx}">${bucket}</label>
</div>
<div class="bucket-details" id="details-${bucket}" style="display: none;">`;
if (tool.staticComments[bucket] && tool.staticComments[bucket].length > 0) {
  if (bucket === 'HVA sub intent') {
    // primary select for HVA sub intent (list of primary sub-intent names)
    html += `
    <select class="form-control form-control-compact" name="${bucket}-static" id="hva-primary-select" onchange="(function(e){markUnsaved(); toggleHVADetail(e.target);})(event)">
      <option value="">Select a sub-intent...</option>
      ${tool.staticComments[bucket].map(c => `<option value="${c}">${c}</option>`).join('')}
    </select>
    <select class="form-control form-control-compact" id="hva-detail-select" name="${bucket}-detail" style="display:none; margin-top:8px;" onchange="markUnsaved()">
      <option value="">Choose detail...</option>
    </select>
    <textarea class="form-control form-control-compact" name="${bucket}-sub" id="hva-sub-text" placeholder="Please Provide Your Sub Comment" rows="2" oninput="markUnsaved()"></textarea>`;
  } else {
    html += `
    <select class="form-control form-control-compact" name="${bucket}-static" onchange="markUnsaved()">
      <option value="">Select a predefined comment...</option>
      ${tool.staticComments[bucket].map(c => `<option value="${c}">${c}</option>`).join('')}
    </select>
    <textarea class="form-control form-control-compact" name="${bucket}-sub" placeholder="Please Provide Your Sub Comment" rows="2" oninput="markUnsaved()"></textarea>`;
  }
} else {
  html += `<textarea class="form-control form-control-compact" name="${bucket}" placeholder="Add comments" rows="2" oninput="markUnsaved()"></textarea>`;
}
html += `</div>`;
});

html += `</div></div>
<div class="form-section">
<div class="form-section-title">Overall Observations <span class="required-star">*</span></div>
<textarea class="form-control" name="overall-observations" placeholder="Please Provide Your Overall Obervations" rows="3" oninput="markUnsaved()"></textarea>
</div>`;
elements.feedbackForm.innerHTML = html;
}

function saveToLocalStorage() {
try {
localStorage.setItem(`annotator_${tool.fileName}`, JSON.stringify({
fileName: tool.fileName,
annotations: tool.annotations,
currentIndex: tool.currentIndex,
conversations: tool.conversations,
timestamp: new Date().toISOString()
}));
localStorage.setItem('annotator_active_session', tool.fileName);
} catch (e) { console.error('Save failed:', e); }
}

function loadFromLocalStorage(fileName) {
try {
const saved = localStorage.getItem(`annotator_${fileName}`);
if (saved) {
const parsed = JSON.parse(saved);
if (parsed.conversations && parsed.conversations.length > 0) {
tool.annotations = parsed.annotations || {};
tool.currentIndex = parsed.currentIndex || 0;
tool.conversations = parsed.conversations;
tool.fileName = parsed.fileName || fileName;
return true;
}
}
} catch (e) { console.error('Load failed:', e); }
return false;
}

function checkActiveSession() {
try {
const activeSession = localStorage.getItem('annotator_active_session');
if (activeSession && loadFromLocalStorage(activeSession) && tool.conversations.length > 0) {
elements.uploadScreen.style.display = 'none';
elements.mainInterface.style.display = 'flex';
elements.jumpInput.max = tool.conversations.length;
createFeedbackForm();
updateProgressBar();
displayConversation();
updateAnnotatedCount();
showStatus(' Session restored!', 'success');
return true;
}
} catch (e) { console.error('Session check failed:', e); }
return false;
}

async function readExcelFile(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = (e) => {
try {
const data = new Uint8Array(e.target.result);
const workbook = XLSX.read(data, {type: 'array'});
const sheet = workbook.Sheets[workbook.SheetNames[0]];
resolve(XLSX.utils.sheet_to_json(sheet));
} catch (err) { reject(err); }
};
reader.onerror = () => reject(new Error('Read failed'));
reader.readAsArrayBuffer(file);
});
}

function processExcelData(rawData) {
const grouped = {};
rawData.forEach(row => {
if (!grouped[row.Id]) grouped[row.Id] = [];
grouped[row.Id].push(row);
});
tool.conversations = Object.values(grouped);
tool.currentIndex = 0;
tool.annotations = {};
elements.jumpInput.max = tool.conversations.length;
loadFromLocalStorage(tool.fileName);
saveToLocalStorage();
updateProgressBar();
displayConversation();
updateAnnotatedCount();
}

function updateProgressBar() {
elements.progressBar.innerHTML = '';
if (!tool.conversations || tool.conversations.length === 0) return;
const segW = 100 / tool.conversations.length;
tool.conversations.forEach((conv, i) => {
const convId = conv[0].Id;
const isAnn = tool.annotations[convId] && Object.keys(tool.annotations[convId]).length > 0;
const seg = document.createElement('div');
seg.className = `progress-segment ${isAnn ? 'annotated' : 'not-annotated'} ${i === tool.currentIndex ? 'current' : ''}`;
seg.style.width = `${segW}%`;
seg.title = `#${i+1} ${isAnn ? '‚úì' : ' '}`;
seg.onclick = () => { if (tool.hasUnsavedChanges && !confirm('Unsaved changes. Continue?')) return; tool.currentIndex = i; displayConversation(); };
elements.progressBar.appendChild(seg);
});
}

function displayConversation() {
if (!tool.conversations || tool.conversations.length === 0) return;
const conv = tool.conversations[tool.currentIndex];
if (!conv || conv.length === 0) return;
const convId = conv[0].Id;
const isAnn = tool.annotations[convId] && Object.keys(tool.annotations[convId]).length > 0;
const lastMsg = conv[conv.length - 1];

elements.conversationInfo.innerHTML = `<div><strong>ID:</strong> ${convId}</div>
<div><strong>Feedback:</strong> <span class="badge ${lastMsg['Customer Feedback']?.toLowerCase() === 'negative' ? 'badge-danger' : 'badge-success'}">${lastMsg['Customer Feedback'] || 'N/A'}</span></div>`;
elements.annotationStatus.innerHTML = `<div class="status-indicator ${isAnn ? 'status-annotated' : 'status-not-annotated'}">${isAnn ? '‚úì Annotated' : ' Not Annotated'}</div>`;

let html = '';
conv.forEach(m => {
if (m.llmGeneratedUserMessage) html += `<div class="message customer"><div class="message-header"> Customer</div>${m.llmGeneratedUserMessage}</div>`;
if (m.botMessage) html += `<div class="message bot"><div class="message-header"> Bot</div>${m.botMessage}</div>`;
});
elements.conversationDisplay.innerHTML = html;
elements.conversationDisplay.scrollTop = 0;
elements.progressText.textContent = `${tool.currentIndex + 1}/${tool.conversations.length}`;
updateProgressBar();
createFeedbackForm(); // recreate form to ensure consistent DOM ids
loadAnnotations();
clearUnsaved();
}

function updateAnnotatedCount() {
const annConvs = Object.keys(tool.annotations).filter(id => Object.keys(tool.annotations[id]).length > 0).length;
let chats = 0;
tool.conversations.forEach(conv => {
const cid = conv[0].Id;
if (tool.annotations[cid] && Object.keys(tool.annotations[cid]).length > 0) {
chats += conv.filter(m => m.llmGeneratedUserMessage).length;
}
});
elements.annotatedCount.textContent = `${annConvs} Conv | ${chats} Chats Annotated`;
}

function saveCurrentAnnotations() {
  if (!tool.conversations || tool.conversations.length === 0) return;
  const convId = tool.conversations[tool.currentIndex][0].Id;
  const temp = {};

  const botResp = document.querySelector('input[name="bot-response"]:checked');
  if (!botResp) { showStatus(' Please select Bot Response', 'warning'); return; }
  temp["Bot Response"] = botResp.value;

  const hva = document.getElementById('hva-select');
  if (!hva.value) { showStatus(' Please select HVA', 'warning'); return; }
  temp["HVA"] = hva.value;

  const anyChecked = document.querySelectorAll('input[name="bucket-checkbox"]:checked').length > 0;
  if (!anyChecked) { showStatus(' Please select at least one Annotation Category', 'warning'); return; }

  let missing = false, missingBucket = '', missingDetail = false;

  tool.buckets.slice(2, -1).forEach((bucket, idx) => {
    const cb = document.querySelector(`input[value="${bucket}"]`);
    if (cb && cb.checked) {
      if (tool.staticComments[bucket] && tool.staticComments[bucket].length > 0) {
        // Special handling for HVA sub intent (primary + detail)
        if (bucket === 'HVA sub intent') {
          const primary = document.getElementById('hva-primary-select');
          const detail = document.getElementById('hva-detail-select');
          const subText = document.getElementById('hva-sub-text');

          // primary must be chosen
          if (!primary || !primary.value) {
            missing = true; missingBucket = bucket; return;
          }

          // If detail select is visible (there are details for the selected primary),
          // make selection of detail mandatory.
          const detailVisible = detail && detail.style.display !== 'none';

          if (detailVisible) {
            if (!detail.value) {
              missing = true; missingBucket = bucket; missingDetail = true; return;
            }
            // prefer detail as canonical stored value
            temp['HVA sub intent'] = detail.value;
            temp[bucket] = (subText && subText.value.trim()) ? detail.value + ' - ' + subText.value.trim() : detail.value;
          } else {
            // no detail list available ‚Äî primary alone is accepted
            temp['HVA sub intent'] = primary.value;
            temp[bucket] = (subText && subText.value.trim()) ? primary.value + ' - ' + subText.value.trim() : primary.value;
          }
        } else {
          const staticSel = document.querySelector(`select[name="${bucket}-static"]`);
          if (!staticSel || !staticSel.value) { missing = true; missingBucket = bucket; return; }
          const sub = document.querySelector(`textarea[name="${bucket}-sub"]`);
          temp[bucket] = staticSel.value + (sub && sub.value.trim() ? ' - ' + sub.value.trim() : '');
        }
      } else {
        const ta = document.querySelector(`textarea[name="${bucket}"]`);
        if (ta && ta.value.trim()) temp[bucket] = ta.value.trim();
        // if bucket has no static comments and textarea is blank, allow it? If you want to force text too, add validation here.
      }
    }
  });

  if (missing) {
    if (missingDetail) showStatus(` Please choose a detail for ${missingBucket}`, 'warning');
    else showStatus(` Select predefined comment for ${missingBucket}`, 'warning');
    return;
  }

  const obs = document.querySelector('textarea[name="overall-observations"]');
  if (!obs || !obs.value.trim()) { showStatus(' Please provide Overall Observations', 'warning'); return; }
  temp["Overall Observations"] = obs.value.trim();
  temp["Timestamp"] = new Date().toLocaleString();

  tool.annotations[convId] = temp;
  saveToLocalStorage();
  clearUnsaved();
  updateAnnotatedCount();
  updateProgressBar();
  elements.annotationStatus.innerHTML = `<div class="status-indicator status-annotated">‚úì Annotated</div>`;
  showStatus(' Saved!', 'success');
  setTimeout(() => {
    if (tool.currentIndex < tool.conversations.length - 1) { tool.currentIndex++; displayConversation(); }
    else showStatus(' All done!', 'success');
  }, 500);
}

function loadAnnotations() {
if (!tool.conversations || tool.conversations.length === 0) return;
const convId = tool.conversations[tool.currentIndex][0].Id;
const saved = tool.annotations[convId] || {};

document.querySelectorAll('input[name="bot-response"]').forEach(r => r.checked = false);
document.getElementById('hva-select').value = '';
document.querySelectorAll('input[name="bucket-checkbox"]').forEach(c => c.checked = false);
document.querySelectorAll('.bucket-details').forEach(d => d.style.display = 'none');
document.querySelectorAll('select[name*="-static"]').forEach(s => s.value = '');
document.querySelectorAll('textarea').forEach(t => t.value = '');

if (saved["Bot Response"]) {
const r = document.querySelector(`input[name="bot-response"][value="${saved["Bot Response"]}"]`);
if (r) r.checked = true;
}
if (saved["HVA"]) document.getElementById('hva-select').value = saved["HVA"];
if (saved["Overall Observations"]) document.querySelector('textarea[name="overall-observations"]').value = saved["Overall Observations"];

// restore buckets
tool.buckets.slice(2, -1).forEach((bucket, idx) => {
if (saved[bucket]) {
const cb = document.querySelector(`input[value="${bucket}"]`);
if (cb) { cb.checked = true; document.getElementById(`details-${bucket}`).style.display = 'block'; }
if (tool.staticComments[bucket] && tool.staticComments[bucket].length > 0) {
  if (bucket === 'HVA sub intent') {
    const primarySel = document.getElementById('hva-primary-select');
    const detailSel = document.getElementById('hva-detail-select');
    const subText = document.getElementById('hva-sub-text');
    // Prefer saved['HVA sub intent'] as canonical stored value (could be detail or primary)
    const hvSaved = saved['HVA sub intent'] || saved[bucket] || '';
    // Try to see if hvSaved matches any detailed option; if yes, populate primary & detail
    let matchedParent = null, matchedDetail = null;
    Object.keys(subOptionsMap).forEach(parent => {
      subOptionsMap[parent].forEach(detail => {
        if (detail === hvSaved) { matchedParent = parent; matchedDetail = detail; }
      });
    });
    if (matchedParent) {
      // set primary select to the value in tool.staticComments (find option containing matchedParent)
      if (primarySel) {
        for (let i = 0; i < primarySel.options.length; i++) {
          const op = primarySel.options[i];
          if (op.value && op.value.toLowerCase().includes(matchedParent.toLowerCase())) { primarySel.value = op.value; break; }
        }
        // populate detail select and set matchedDetail
        toggleHVADetail(primarySel);
        if (detailSel) { detailSel.value = matchedDetail; detailSel.style.display = 'block'; }
      }
    } else {
      // hvSaved didn't match a known detail; maybe it's the primary label or primary + subtext format
      if (primarySel) {
        // if hvSaved contains ' - ' then split
        if (hvSaved.includes(' - ')) {
          const parts = hvSaved.split(' - ');
          primarySel.value = parts[0] || '';
          toggleHVADetail(primarySel);
          // subtext
          if (subText) subText.value = parts.slice(1).join(' - ');
        } else {
          // try to set primary directly
          for (let i = 0; i < primarySel.options.length; i++) {
            const op = primarySel.options[i];
            if (op.value && op.value.toLowerCase() === hvSaved.toLowerCase()) { primarySel.value = op.value; toggleHVADetail(primarySel); break; }
          }
          // if still empty, try to set primary to an option that contains hvSaved
          if (!primarySel.value) {
            for (let i = 0; i < primarySel.options.length; i++) {
              const op = primarySel.options[i];
              if (op.value && op.value.toLowerCase().includes(hvSaved.toLowerCase())) { primarySel.value = op.value; toggleHVADetail(primarySel); break; }
            }
          }
        }
      }
      // also, if saved[bucket] had a sub-comment after ' - ', populate sub text area
      if (saved[bucket] && saved[bucket].includes(' - ')) {
        const parts = saved[bucket].split(' - ');
        if (subText) subText.value = parts.slice(1).join(' - ');
      }
    }
  } else {
    const parts = saved[bucket].split(' - ');
    const staticSel = document.querySelector(`select[name="${bucket}-static"]`);
    const sub = document.querySelector(`textarea[name="${bucket}-sub"]`);
    if (staticSel) staticSel.value = parts[0];
    if (sub) sub.value = parts.slice(1).join(' - ');
  }
} else {
const ta = document.querySelector(`textarea[name="${bucket}"]`);
if (ta) ta.value = saved[bucket];
}
}
});
}

function s2ab(s) {
const buf = new ArrayBuffer(s.length);
const view = new Uint8Array(buf);
for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
return buf;
}

elements.fileInput.addEventListener('change', async (e) => {
const file = e.target.files[0];
if (!file) return;
if (!file.name.match(/\.xlsx?$/i)) { showStatus(' Please select Excel file', 'error'); return; }
if (!tool.userName) { showLoginModal(); return; }
try {
showLoading(true);
tool.fileName = file.name.replace(/\.xlsx?$/i, '');
const data = await readExcelFile(file);
if (!data || data.length === 0) throw new Error('No data');
processExcelData(data);
elements.uploadScreen.style.display = 'none';
elements.mainInterface.style.display = 'flex';
showStatus(' File loaded!', 'success');
} catch (err) {
console.error(err);
showStatus(' Error loading file', 'error');
} finally { showLoading(false); }
});

elements.uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); elements.uploadBox.style.background = '#e3f2fd'; });
elements.uploadBox.addEventListener('dragleave', (e) => { e.preventDefault(); elements.uploadBox.style.background = ''; });
elements.uploadBox.addEventListener('drop', (e) => {
e.preventDefault();
elements.uploadBox.style.background = '';
if (!tool.userName) { showLoginModal(); return; }
const file = e.dataTransfer.files[0];
if (file) {
const dt = new DataTransfer();
dt.items.add(file);
elements.fileInput.files = dt.files;
elements.fileInput.dispatchEvent(new Event('change'));
}
});

elements.prevBtn.addEventListener('click', () => {
if (tool.hasUnsavedChanges && !confirm('Unsaved changes. Continue?')) return;
if (tool.currentIndex > 0) { tool.currentIndex--; displayConversation(); }
});

elements.nextBtn.addEventListener('click', () => {
if (tool.hasUnsavedChanges && !confirm('Unsaved changes. Continue?')) return;
if (tool.currentIndex < tool.conversations.length - 1) { tool.currentIndex++; displayConversation(); }
});

elements.saveBtn.addEventListener('click', saveCurrentAnnotations);

elements.jumpBtn.addEventListener('click', () => {
const v = parseInt(elements.jumpInput.value);
if (!v || v < 1 || v > tool.conversations.length) { showStatus(' Invalid number', 'warning'); return; }
if (tool.hasUnsavedChanges && !confirm('Unsaved changes. Continue?')) return;
tool.currentIndex = v - 1;
displayConversation();
});

elements.jumpInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') elements.jumpBtn.click(); });

elements.downloadBtn.addEventListener('click', () => {
if (Object.keys(tool.annotations).length === 0) { showStatus(' No annotations', 'warning'); return; }
showLoading(true);
const rows = [];
tool.conversations.forEach(conv => {
const cid = conv[0].Id;
const ann = tool.annotations[cid];
if (ann && Object.keys(ann).length > 0) {
conv.forEach(m => {
rows.push({
'Id': m.Id, 'llmGeneratedUserMessage': m.llmGeneratedUserMessage || '', 'botMessage': m.botMessage || '',
'Customer Feedback': m['Customer Feedback'] || '', 'Bot Response': ann['Bot Response'] || '',
'HVA': ann['HVA'] || '', 'AB feature/HVA Related Query': ann['AB feature/HVA Related Query'] || '',
 'HVA sub intent': ann['HVA sub intent'] || '',
'Personalized/Account-Specific Queries': ann['Personalized/Account-Specific Queries'] || '',
'Bot Limitations': ann['Bot Limitations'] || '',
'Promo & Freebie Related Queries': ann['Promo & Freebie Related Queries'] || '',
'Help-page/Direct Customer Service': ann['Help-page/Direct Customer Service'] || '',
'BP for Non-Profit Organisation Related Query': ann['BP for Non-Profit Organisation Related Query'] || '',
'Personal Prime Related Query': ann['Personal Prime Related Query'] || '',
'Customer Behavior': ann['Customer Behavior'] || '', 'Other Queries': ann['Other Queries'] || '',
'Overall Observations': ann['Overall Observations'] || '', 'Login': tool.userName, 'Timestamp': ann['Timestamp'] || ''
});
});
}
});
if (rows.length === 0) { showLoading(false); showStatus(' No annotated data', 'warning'); return; }
const ws = XLSX.utils.json_to_sheet(rows);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Annotations");
const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
const loginName = tool.userName.replace(/[^a-zA-Z0-9]/g, '_');
a.download = `annotated_${loginName}_${new Date().toISOString().replace(/[:.]/g, '-')}.xlsx`;
a.click();
showLoading(false);
showStatus(' Downloaded!', 'success');
});

elements.downloadUnannotatedBtn.addEventListener('click', () => {
showLoading(true);
const rows = [];
tool.conversations.forEach(conv => {
const cid = conv[0].Id;
if (!tool.annotations[cid] || Object.keys(tool.annotations[cid]).length === 0) {
conv.forEach((m, i) => {
rows.push({
'Id': m.Id, 'llmGeneratedUserMessage': m.llmGeneratedUserMessage || '', 'botMessage': m.botMessage || '',
'Customer Feedback': i === conv.length - 1 ? m['Customer Feedback'] || '' : ''
});
});
}
});
if (rows.length === 0) { showLoading(false); showStatus(' All annotated!', 'success'); return; }
const ws = XLSX.utils.json_to_sheet(rows);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "Unannotated");
const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});
const blob = new Blob([s2ab(wbout)], {type: 'application/octet-stream'});
const a = document.createElement('a');
a.href = URL.createObjectURL(blob);
const loginName = tool.userName.replace(/[^a-zA-Z0-9]/g, '_');
a.download = `unannotated_${loginName}_${new Date().toISOString().replace(/[:.]/g, '-')}.xlsx`;
a.click();
showLoading(false);
showStatus(' Downloaded!', 'success');
});

elements.exitBtn.addEventListener('click', () => {
if (tool.hasUnsavedChanges && confirm('Save before exit?')) saveToLocalStorage();
tool.currentIndex = 0;
tool.conversations = [];
tool.annotations = {};
tool.hasUnsavedChanges = false;
clearUnsaved();
elements.mainInterface.style.display = 'none';
elements.uploadScreen.style.display = 'flex';
elements.fileInput.value = '';
});

document.addEventListener('keydown', (e) => {
if (elements.mainInterface.style.display === 'none') return;
if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') { e.preventDefault(); elements.saveBtn.click(); }
if (e.key === 'ArrowLeft' && !e.target.matches('input,textarea,select')) elements.prevBtn.click();
if (e.key === 'ArrowRight' && !e.target.matches('input,textarea,select')) elements.nextBtn.click();
}, true);

createFeedbackForm();
checkActiveSession();
});
</script>
</body>
</html>
